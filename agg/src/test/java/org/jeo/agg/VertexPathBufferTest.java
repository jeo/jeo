package org.jeo.agg;

import static org.jeo.geom.CoordinatePath.PathStep.*;
import static org.easymock.classextension.EasyMock.*;
import static org.junit.Assert.*;

import java.nio.ByteBuffer;

import org.jeo.geom.CoordinatePath;
import org.jeo.geom.GeometryBuilder;
import org.jeo.geom.CoordinatePath.PathStep;
import org.junit.Test;

import sun.security.x509.CertException;

import com.vividsolutions.jts.geom.Coordinate;
import com.vividsolutions.jts.geom.Geometry;
import com.vividsolutions.jts.io.ParseException;
import com.vividsolutions.jts.io.WKTReader;

public class VertexPathBufferTest {

    @Test
    public void test() {
        doSimpleTest(new VertexPathBuffer());
    }

    @Test
    public void testAutoExpand() {
        doSimpleTest(new VertexPathBuffer(10));
    }

    @Test
    public void testReal() throws ParseException {
        Geometry g = new WKTReader().read("POLYGON ((-88.071564 37.51099000000001, -88.087883 37.476273000000006, -88.311707 37.442852, -88.359177 37.40930899999999, -88.419853 37.420292, -88.467644 37.400757, -88.511322 37.296852, -88.501427 37.257782000000006, -88.450699 37.205669, -88.422516 37.156909999999996, -88.45047 37.098670999999996, -88.476799 37.072143999999994, -88.4907 37.06818, -88.517273 37.064769999999996, -88.559273 37.072815000000006, -88.61422 37.109047000000004, -88.68837 37.13540999999999, -88.739113 37.141182, -88.746506 37.152107, -88.863289 37.202194000000006, -88.932503 37.218407, -88.993172 37.22003599999999, -89.065033 37.185860000000005, -89.116821 37.112137000000004, -89.146347 37.093185000000005, -89.169548 37.064235999999994, -89.174332 37.025711, -89.150246 36.99844, -89.12986 36.988113, -89.193512 36.986771000000005, -89.210052 37.02897299999999, -89.237679 37.041732999999994, -89.264053 37.087124, -89.284233 37.091244, -89.303291 37.085384000000005, -89.3097 37.060908999999995, -89.264244 37.027733, -89.262001 37.008686, -89.282768 36.999207, -89.310982 37.009682, -89.38295 37.049212999999995, -89.37999 37.09908299999999, -89.423798 37.137203, -89.440521 37.165318, -89.468216 37.224266, -89.465309 37.253731, -89.489594 37.256001, -89.513885 37.276402000000004, -89.513885 37.304962, -89.50058 37.329441, -89.468742 37.339409, -89.435738 37.355717, -89.427574 37.411018, -89.453621 37.453186, -89.494781 37.491726, -89.524971 37.571957, -89.513367 37.615928999999994, -89.51918 37.650375, -89.513374 37.67984, -89.521523 37.694798000000006, -89.581436 37.706103999999996, -89.666458 37.745453, -89.675858 37.78397, -89.691055 37.804794, -89.728447 37.840992, -89.851715 37.905063999999996, -89.861046 37.905486999999994, -89.866814 37.891875999999996, -89.900551 37.875904000000006, -89.937874 37.878044, -89.978912 37.911884, -89.958229 37.963634, -90.010811 37.969318, -90.041924 37.993206, -90.119339 38.032272000000006, -90.134712 38.05395100000001, -90.207527 38.08890500000001, -90.254059 38.122169000000014, -90.289635 38.16681700000001, -90.336716 38.18871300000001, -90.364769 38.23429899999999, -90.369347 38.32355899999999, -90.358688 38.36533, -90.339607 38.39084600000001, -90.301842 38.427357, -90.265785 38.518688, -90.26123 38.532768000000004, -90.240944 38.562805, -90.183708 38.61027100000001, -90.183578 38.658772, -90.20224 38.70036300000001, -90.196571 38.72396499999999, -90.163399 38.773098000000005, -90.135178 38.785484, -90.121727 38.80051, -90.113121 38.830467, -90.132812 38.85303099999999, -90.243927 38.91450900000001, -90.278931 38.92471699999999, -90.31974 38.92490799999999, -90.413071 38.96233000000001, -90.469841 38.959179000000006, -90.530426 38.89160899999999, -90.570328 38.87132600000001, -90.627213 38.880795000000006, -90.668877 38.93525299999999, -90.70607 39.037791999999996, -90.707588 39.058178, -90.690399 39.09370000000001, -90.716736 39.14421100000001, -90.718193 39.195873000000006, -90.732338 39.22474700000001, -90.738083 39.24780999999999, -90.779343 39.29680300000001, -90.850494 39.35045199999999, -90.947891 39.40058500000001, -91.036339 39.444412, -91.064384 39.473984, -91.093613 39.52892700000001, -91.156189 39.552593, -91.203247 39.600021, -91.317665 39.68591699999999, -91.367088 39.724639999999994, -91.373421 39.76127199999999, -91.381714 39.80377200000001, -91.449188 39.86304899999999, -91.450989 39.885242000000005, -91.434052 39.90182899999999, -91.430389 39.92183700000001, -91.447243 39.94606400000001, -91.487289 40.005753, -91.504005 40.066711, -91.516129 40.134544000000005, -91.506546 40.200458999999995, -91.498932 40.25137699999999, -91.486694 40.309624000000014, -91.448593 40.371902000000006, -91.418816 40.386875, -91.385757 40.392360999999994, -91.372757 40.40298799999999, -91.385399 40.44725, -91.374794 40.50365400000001, -91.382103 40.52849599999999, -91.412872 40.54799299999999, -91.411118 40.572970999999995, -91.37561 40.60343900000001, -91.262062 40.639545, -91.214912 40.64381800000001, -91.162498 40.65631099999999, -91.129158 40.68214800000001, -91.119987 40.70540199999999, -91.092751 40.76154700000001, -91.088905 40.833729000000005, -91.04921 40.87958499999999, -90.983276 40.92392699999999, -90.960709 40.950503999999995, -90.954651 41.07036199999999, -90.957787 41.10435899999999, -90.990341 41.14437100000001, -91.018257 41.16582500000001, -91.05632 41.17625799999999, -91.101524 41.23152200000001, -91.102348 41.267818000000005, -91.07328 41.334895999999986, -91.055786 41.40137899999999, -91.027489 41.423508, -91.000694 41.431084, -90.949654 41.421234, -90.844139 41.44462200000001, -90.7799 41.449820999999986, -90.708214 41.450062, -90.658791 41.46231800000001, -90.6007 41.50958600000001, -90.54084 41.52597, -90.454994 41.527546, -90.434967 41.543578999999994, -90.423004 41.567272, -90.348366 41.586849, -90.339348 41.60279800000001, -90.341133 41.64909, -90.326027 41.722736, -90.304886 41.75646599999999, -90.25531 41.78173799999999, -90.195839 41.80613700000001, -90.154518 41.93077500000001, -90.14267 41.98396299999999, -90.150536 42.03342799999999, -90.168098 42.06104300000001, -90.166649 42.103745, -90.176086 42.12050199999999, -90.191574 42.12268800000001, -90.230934 42.15972099999999, -90.323601 42.19731899999999, -90.367729 42.21020899999999, -90.407173 42.24264500000001, -90.417984 42.263924, -90.427681 42.340633, -90.441597 42.360073, -90.491043 42.38878299999999, -90.563583 42.42183700000001, -90.605827 42.46055999999999, -90.648346 42.47564299999999, -90.651772 42.494698, -90.638329 42.50936100000001, -90.419975 42.508362000000005, -89.923569 42.504108, -89.834618 42.50345999999999, -89.400497 42.49749, -89.359444 42.497906, -88.939079 42.49086399999999, -88.764954 42.490905999999995, -88.70652 42.489655, -88.297897 42.49197000000001, -88.194702 42.48961299999999, -87.79731 42.48913200000001, -87.836945 42.314212999999995, -87.760239 42.15645599999999, -87.670547 42.059822, -87.612625 41.847331999999994, -87.529861 41.723591, -87.532646 41.46971500000001, -87.532448 41.30130399999999, -87.531731 41.173756, -87.532021 41.00993, -87.532669 40.74541099999999, -87.53717 40.494609999999994, -87.535675 40.48324600000001, -87.535339 40.16619499999999, -87.535774 39.887302000000005, -87.535576 39.609341, -87.538567 39.47744800000001, -87.540215 39.350525000000005, -87.597664 39.338268, -87.625237 39.30740399999999, -87.610619 39.297661000000005, -87.615799 39.281418, -87.606895 39.258162999999996, -87.584564 39.248752999999994, -87.588593 39.20846599999999, -87.594208 39.198128, -87.607925 39.196068, -87.644257 39.168507000000005, -87.670326 39.146679000000006, -87.659454 39.130652999999995, -87.662262 39.11346800000001, -87.631668 39.10394299999999, -87.630867 39.08897400000001, -87.612007 39.08460600000001, -87.58532 39.062434999999994, -87.581749 38.995743000000004, -87.591858 38.99408299999999, -87.547905 38.97707700000001, -87.53347 38.96370300000001, -87.530182 38.93191899999999, -87.5392 38.90486100000001, -87.559059 38.869811999999996, -87.550507 38.857890999999995, -87.507889 38.795559, -87.519028 38.77669900000001, -87.508003 38.769722, -87.508316 38.73663300000001, -87.543892 38.68597399999999, -87.588478 38.672169, -87.625191 38.642810999999995, -87.628647 38.622917, -87.619827 38.599209, -87.640594 38.593177999999995, -87.652855 38.573871999999994, -87.672943 38.54742400000001, -87.65139 38.51536899999999, -87.653534 38.50044299999999, -87.679909 38.50400500000001, -87.692818 38.48153300000001, -87.756096 38.466125000000005, -87.758659 38.45709600000001, -87.738953 38.44548, -87.748428 38.41796500000001, -87.784019 38.378124000000014, -87.834503 38.35252399999999, -87.850082 38.28609800000001, -87.863007 38.28536199999999, -87.874039 38.316788, -87.883446 38.315552, -87.888466 38.300658999999996, -87.914108 38.281048, -87.913651 38.302345, -87.925919 38.30477099999999, -87.980019 38.241085, -87.986008 38.234814, -87.977928 38.200714000000005, -87.932289 38.171131, -87.931992 38.15752800000001, -87.950569 38.13691299999999, -87.973503 38.131760000000014, -88.018547 38.10330200000001, -88.012329 38.09234599999999, -87.964867 38.09674799999999, -87.975296 38.073307, -88.034729 38.054084999999986, -88.043091 38.04512, -88.041473 38.03830300000001, -88.021698 38.03353100000001, -88.029213 38.00823600000001, -88.021706 37.975055999999995, -88.042511 37.956264000000004, -88.041771 37.934498000000005, -88.064621 37.929783, -88.078941 37.944, -88.084 37.92366, -88.030441 37.917591, -88.026588 37.905758000000006, -88.044868 37.896004000000005, -88.100082 37.90617, -88.101456 37.895306000000005, -88.075737 37.867808999999994, -88.034241 37.843745999999996, -88.042137 37.827522, -88.089264 37.831249, -88.086029 37.817612, -88.035576 37.805683, -88.072472 37.735400999999996, -88.133636 37.700745, -88.15937 37.660686, -88.157631 37.628479, -88.134171 37.583572000000004, -88.071564 37.51099000000001))");
        CoordinatePath path1 = CoordinatePath.create(g);
        CoordinatePath path2 = CoordinatePath.create(g);

        VertexPathBuffer vpb = new VertexPathBuffer();
        vpb.fill(path1);

        ByteBuffer buf = vpb.buffer();
        while(path2.hasNext()) {
            PathStep step = path2.getStep();

            byte b = buf.get();
            switch(step) {
            case MOVE_TO:
                assertEquals(VertexPathBuffer.MOVE_TO, b); break;
            case LINE_TO:
                assertEquals(VertexPathBuffer.LINE_TO, b); break;
            case CLOSE:
                assertEquals(VertexPathBuffer.END_POLY, b); break;
            default:
                fail();
            }
            
            Coordinate c = path2.next();
            assertEquals((float)c.x, buf.getFloat(), 0.1);
            assertEquals((float)c.y, buf.getFloat(), 0.1);
        }

        assertEquals(VertexPathBuffer.STOP, buf.get());
        assertEquals(0, buf.remaining());
    }

    void doSimpleTest(VertexPathBuffer buf) {
        CoordinatePath path = mock(MOVE_TO,0,0, LINE_TO,1,1, LINE_TO,2,2);
        buf.fill(path);

        ByteBuffer b = buf.buffer();
        
        assertEquals(VertexPathBuffer.MOVE_TO, b.get());
        assertEquals(0f, b.getFloat(), 0.1);
        assertEquals(0f, b.getFloat(), 0.1);
        
        assertEquals(VertexPathBuffer.LINE_TO, b.get());
        assertEquals(1f, b.getFloat(), 0.1);
        assertEquals(1f, b.getFloat(), 0.1);
        
        assertEquals(VertexPathBuffer.LINE_TO, b.get());
        assertEquals(2f, b.getFloat(), 0.1);
        assertEquals(2f, b.getFloat(), 0.1);

        assertEquals(VertexPathBuffer.STOP, b.get());
        assertEquals(0, b.remaining());
    }

    CoordinatePath mock(Object...path) {
        assertEquals(0, path.length%3);

        CoordinatePath p = createMock(CoordinatePath.class);
        for (int i = 0; i < path.length; i += 3) {
            expect(p.hasNext()).andReturn(true).once();
            expect(p.getStep()).andReturn((PathStep) path[i]).once();

            Coordinate c = new Coordinate(((Number)path[i+1]).doubleValue(),
                ((Number)path[i+2]).doubleValue());
            expect(p.next()).andReturn(c).once();
        }

        expect(p.hasNext()).andReturn(false).once();
        replay(p);
        return p;
    }
}
